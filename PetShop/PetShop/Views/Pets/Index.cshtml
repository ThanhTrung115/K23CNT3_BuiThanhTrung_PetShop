@model IEnumerable<PetShop.Models.Pet>
@{
    ViewData["Title"] = ViewData["PageTitle"]?.ToString();
    var categories = ViewData["Categories"] as List<PetCategory>;
    var selectedCategoryId = ViewData["SelectedCategoryId"] as int?;
}

<div class="container">
    <div class="text-center mb-4">
        <h1 class="display-4">@ViewData["PageTitle"]</h1>
    </div>
    <nav class="category-filter-nav mb-5">
        <ul class="list-unstyled d-flex justify-content-center flex-wrap">
            @{
                string allActiveClass = !selectedCategoryId.HasValue ? "active" : "";
            }
            <li><a asp-action="Index" class="@allActiveClass">Tất cả</a></li>
            @if (categories != null)
            {
                @foreach (var category in categories)
                {
                    string activeClass = (category.CategoryId == selectedCategoryId) ? "active" : "";
                    <li>
                        <a asp-action="Index" asp-route-categoryId="@category.CategoryId" class="@activeClass">
                            @category.CategoryName
                        </a>
                    </li>
                }
            }
        </ul>
    </nav>
    <div class="row">
        @foreach (var pet in Model)
        {
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                <div class="card h-100 product-card">
                    <div class="card-image-container">
                        <img src="https://placehold.co/300x300" class="card-img-top" alt="@pet.PetName">
                        <a asp-action="Details" asp-route-id="@pet.PetId" class="btn btn-light details-button">Xem chi tiết</a>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@pet.PetName</h5>
                        <p class="card-category text-muted">@pet.Category?.CategoryName</p>
                        <p class="card-price">@pet.Price.ToString("N0") VNĐ</p>

                        <button class="btn btn-outline-success mt-auto add-to-cart-btn" data-petid="@pet.PetId">
                            Thêm vào giỏ
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.add-to-cart-btn').on('click', function (e) {
                e.preventDefault();

                var button = $(this);
                var petId = button.data('petid');
                var originalText = button.html();

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("AddToCartApi", "Carts")',
                    data: { petId: petId },
                    success: function (response) {
                        if (response.success) {
                            var badge = $('#cart-badge');
                            badge.text(response.cartItemCount);
                            badge.show();

                            button.html('✓ Đã thêm!');
                            button.removeClass('btn-outline-success').addClass('btn-success');
                            setTimeout(function () {
                                button.html(originalText);
                                button.removeClass('btn-success').addClass('btn-outline-success');
                            }, 1500);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                        alert('Đã xảy ra lỗi. Vui lòng thử lại.');
                    }
                });
            });
        });
    </script>
}